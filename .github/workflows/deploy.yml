name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  BACKEND_IMAGE: event-management-backend
  FRONTEND_IMAGE: event-management-frontend
  DOCKER_REGISTRY: ghcr.io

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        run: |
          # This would need to be configured with actual Kubernetes credentials
          # For demonstration purposes, we'll show the structure
          echo "Configure kubectl with cluster credentials"
          # kubectl config set-cluster <cluster-name> --server=<server-url>
          # kubectl config set-credentials <user> --token=<token>
          # kubectl config set-context <context> --cluster=<cluster> --user=<user>
          # kubectl config use-context <context>
      
      - name: Update Helm Values
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"
          cat > helm-chart/values-override.yaml << EOF
          backend:
            image: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:${IMAGE_TAG}
          
          frontend:
            image: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:${IMAGE_TAG}
          
          ingress:
            host: eventmanagement-${{ inputs.environment }}.local
          EOF
      
      - name: Deploy with Helm
        run: |
          helm upgrade --install event-management ./helm-chart \
            --values helm-chart/values-override.yaml \
            --namespace event-management-${{ inputs.environment }} \
            --create-namespace \
            --wait \
            --timeout 10m
      
      - name: Verify Deployment
        run: |
          kubectl get pods -n event-management-${{ inputs.environment }}
          kubectl get services -n event-management-${{ inputs.environment }}
          kubectl get ingress -n event-management-${{ inputs.environment }}
      
      - name: Run Health Checks
        run: |
          echo "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=backend \
            -n event-management-${{ inputs.environment }} \
            --timeout=300s || true
          
          kubectl wait --for=condition=ready pod \
            -l app=frontend \
            -n event-management-${{ inputs.environment }} \
            --timeout=300s || true
      
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: event-management-${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n event-management-${{ inputs.environment }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
