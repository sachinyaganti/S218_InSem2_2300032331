name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BACKEND_IMAGE: event-management-backend
  FRONTEND_IMAGE: event-management-frontend
  DOCKER_REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Clone Backend Source
        run: |
          cd backend
          git clone https://github.com/suneethabulla/Event-Management-System.git temp
          cp -r temp/backend/* .
          rm -rf temp
      
      - name: Build with Maven
        run: |
          cd backend
          mvn clean package -DskipTests
      
      - name: Run Tests
        run: |
          cd backend
          mvn test || true
      
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-war
          path: backend/target/*.war
          retention-days: 7
      
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Backend Docker Image
        if: github.event_name != 'pull_request'
        run: |
          cd backend
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }} \
                     ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:latest
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE }}:latest

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Clone Frontend Source
        run: |
          cd frontend
          git clone https://github.com/suneethabulla/Event-Management-System.git temp
          cp -r temp/frontend/* .
          rm -rf temp
      
      - name: Install Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
      
      - name: Run Tests
        run: |
          cd frontend
          npm test -- --passWithNoTests || true
      
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7
      
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Frontend Docker Image
        if: github.event_name != 'pull_request'
        run: |
          cd frontend
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }} \
                     ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:latest
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE }}:latest

  helm-lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'
      
      - name: Lint Helm Chart
        run: |
          helm lint ./helm-chart

  deploy-status:
    name: Generate Deployment Report
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, helm-lint]
    if: always()
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Deployment Report
        run: |
          mkdir -p reports
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Event Management System - CI/CD Pipeline</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 12px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      overflow: hidden;
                  }
                  header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px 30px;
                      text-align: center;
                  }
                  h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      font-size: 1.1em;
                      opacity: 0.9;
                  }
                  .content {
                      padding: 30px;
                  }
                  .status-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin: 30px 0;
                  }
                  .status-card {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 20px;
                      border-left: 4px solid #667eea;
                  }
                  .status-card h3 {
                      color: #333;
                      margin-bottom: 10px;
                      font-size: 1.1em;
                  }
                  .status-badge {
                      display: inline-block;
                      padding: 5px 15px;
                      border-radius: 20px;
                      font-size: 0.9em;
                      font-weight: 600;
                      margin-top: 10px;
                  }
                  .success {
                      background: #d4edda;
                      color: #155724;
                  }
                  .info {
                      background: #d1ecf1;
                      color: #0c5460;
                  }
                  .section {
                      margin: 30px 0;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 8px;
                  }
                  .section h2 {
                      color: #333;
                      margin-bottom: 15px;
                      font-size: 1.5em;
                  }
                  .info-list {
                      list-style: none;
                      margin-top: 15px;
                  }
                  .info-list li {
                      padding: 10px 0;
                      border-bottom: 1px solid #e0e0e0;
                  }
                  .info-list li:last-child {
                      border-bottom: none;
                  }
                  .label {
                      font-weight: 600;
                      color: #667eea;
                      display: inline-block;
                      width: 150px;
                  }
                  footer {
                      text-align: center;
                      padding: 20px;
                      color: #666;
                      border-top: 1px solid #e0e0e0;
                  }
                  .badge-container {
                      margin: 20px 0;
                      text-align: center;
                  }
                  .badge-container img {
                      margin: 5px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üöÄ Event Management System</h1>
                      <p class="subtitle">CI/CD Pipeline Dashboard</p>
                  </header>
                  
                  <div class="content">
                      <div class="badge-container">
                          <img src="https://github.com/${{ github.repository }}/actions/workflows/ci-cd.yml/badge.svg" alt="CI/CD Status">
                      </div>

                      <div class="status-grid">
                          <div class="status-card">
                              <h3>üì¶ Backend Build</h3>
                              <p>Spring Boot + Maven</p>
                              <span class="status-badge ${{ needs.build-backend.result == 'success' && 'success' || 'info' }}">
                                  ${{ needs.build-backend.result || 'Running' }}
                              </span>
                          </div>
                          <div class="status-card">
                              <h3>üé® Frontend Build</h3>
                              <p>React + Vite</p>
                              <span class="status-badge ${{ needs.build-frontend.result == 'success' && 'success' || 'info' }}">
                                  ${{ needs.build-frontend.result || 'Running' }}
                              </span>
                          </div>
                          <div class="status-card">
                              <h3>‚öì Helm Charts</h3>
                              <p>Kubernetes Deployment</p>
                              <span class="status-badge ${{ needs.helm-lint.result == 'success' && 'success' || 'info' }}">
                                  ${{ needs.helm-lint.result || 'Running' }}
                              </span>
                          </div>
                      </div>

                      <div class="section">
                          <h2>üìä Build Information</h2>
                          <ul class="info-list">
                              <li><span class="label">Repository:</span> ${{ github.repository }}</li>
                              <li><span class="label">Branch:</span> ${{ github.ref_name }}</li>
                              <li><span class="label">Commit:</span> ${{ github.sha }}</li>
                              <li><span class="label">Triggered by:</span> ${{ github.actor }}</li>
                              <li><span class="label">Workflow Run:</span> #${{ github.run_number }}</li>
                              <li><span class="label">Event:</span> ${{ github.event_name }}</li>
                          </ul>
                      </div>

                      <div class="section">
                          <h2>üèóÔ∏è Project Components</h2>
                          <ul class="info-list">
                              <li><span class="label">Backend:</span> Spring Boot 3.x, Java 17, MySQL 8.0</li>
                              <li><span class="label">Frontend:</span> React, Vite, Nginx</li>
                              <li><span class="label">Deployment:</span> Kubernetes, Helm, Ingress</li>
                              <li><span class="label">Registry:</span> GitHub Container Registry</li>
                              <li><span class="label">Auto-scaling:</span> HPA enabled (2-5 replicas)</li>
                          </ul>
                      </div>

                      <div class="section">
                          <h2>üîó Quick Links</h2>
                          <ul class="info-list">
                              <li><span class="label">Repository:</span> <a href="https://github.com/${{ github.repository }}">View on GitHub</a></li>
                              <li><span class="label">Actions:</span> <a href="https://github.com/${{ github.repository }}/actions">View Workflows</a></li>
                              <li><span class="label">Packages:</span> <a href="https://github.com/${{ github.repository_owner }}?tab=packages&repo_name=${{ github.event.repository.name }}">View Containers</a></li>
                              <li><span class="label">Documentation:</span> <a href="https://github.com/${{ github.repository }}/blob/main/README.md">Read README</a></li>
                          </ul>
                      </div>
                  </div>
                  
                  <footer>
                      <p>Last updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
                      <p>Generated by GitHub Actions</p>
                  </footer>
              </div>
          </body>
          </html>
          EOF
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          commit_message: 'Deploy pipeline status page'
